sequenceDiagram
  participant Dev as Device
  participant Act as Gateway
  participant MQ as LoRa Network/Application Server


  %% --- Start of waveform ---
  Dev->>MQ: Time Waveform Information Uplink (Type 03)
  MQ->>MQ: Log Timestamp, TxID, + Parameters
  MQ->>Dev: Time Waveform Information Acknowledge Downlink (fPort 20, Type 03)

  %% --- Segments may arrive before TWIU ---
  alt TWIU not yet received
    Dev->>MQ: Time Waveform Data Uplink - normal segment (Type 01)
    MQ->>MQ: Insert segment + update bitmap
  end

  %% --- Main transfer loop ---
  loop Each subsequent segment
    Dev->>MQ: Time Waveform Data Uplink - normal segment (Type 01)
    MQ->>MQ: Insert segment + update bitmap
  end

  %% --- Finalization ---
  Dev->>MQ: Time Waveform Data Uplink - final segment (Type 05)
  MQ->>MQ: Assemble and verify
    opt Missing segments detected
    MQ->>Dev: Time Waveform Missing Segments Downlink (fPort 21)
  end
  MQ->>Dev: Commit waveform and mark complete
  MQ->>Dev: Time Waveform Data Acknowledge Downlink (fPort 20, Type 01)